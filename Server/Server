#!/usr/bin/python3
import socket
import sys
from Requests import register, send_message, deliver, recv
action = {'reg' : register,
          'snd' : send_message,
          'del' : deliver}


def main():
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_address = ('localhost', 10000)
    sock.bind(server_address)
    print('socket initialized, ip:{} port:{}'.format(*server_address))
    sock.listen(1)
    
    while True:
        print('Waiting for client')
        connection, client_addr = sock.accept()
        try:
            print('got client {}'.format(client_addr))        
            while True:
                data = recv(connection)
                if data:
                    print('received "{}" from client'.format(data))
                    request, content = data.split('%')

                    #TODO first message from client must specify request
                    if request in ('reg', 'rec', 'del'):
                        action[request](connection, content)
                    else: 
                        connection.sendall(b"I couldn't understand you!")
                    
                else:
                    print('client stopped sending')
                    break
        finally:
            connection.close()




if __name__ == '__main__':
    main()
